#!/usr/bin/env ruby

require 'date'
require 'json'
require 'optparse'

# é¡è‰²é…ç½®
class Colors
  def self.blue(text); "\e[34m#{text}\e[0m"; end
  def self.green(text); "\e[32m#{text}\e[0m"; end
  def self.yellow(text); "\e[33m#{text}\e[0m"; end
  def self.red(text); "\e[31m#{text}\e[0m"; end
  def self.bold(text); "\e[1m#{text}\e[0m"; end
  def self.dim(text); "\e[2m#{text}\e[0m"; end
end

# å–å¾— Git çµ±è¨ˆè³‡æ–™
class GitStats
  def initialize
    @stats = {}
  end

  # åŸ·è¡Œ git å‘½ä»¤
  def run_git_command(cmd)
    `#{cmd}`.strip
  end

  # æ”¶é›†æ¯æ—¥çµ±è¨ˆ
  def collect_daily_stats
    # ä½¿ç”¨ git log å’Œ numstat ä¾†çµ±è¨ˆæ¯å€‹ commit çš„è®ŠåŒ–
    cmd = "git log --pretty=format:'%h %ai' --numstat"
    output = run_git_command(cmd)

    lines = output.split("\n")
    current_date = nil
    current_commit = nil

    lines.each do |line|
      if line.match?(/^\w{7} \d{4}-\d{2}-\d{2}/)
        # é€™æ˜¯ commit è¡Œ
        parts = line.split(' ')
        current_commit = parts[0]
        current_date = parts[1]

        @stats[current_date] ||= { additions: 0, deletions: 0, files: {} }
      elsif line.match?(/^\d+\s+\d+\s+/)
        # é€™æ˜¯ numstat è¡Œ
        next unless current_date

        parts = line.split("\t")
        additions = parts[0].to_i
        deletions = parts[1].to_i
        filename = parts[2]

        # è·³éæŸäº›æª”æ¡ˆ
        next if should_skip?(filename)

        @stats[current_date][:additions] += additions
        @stats[current_date][:deletions] += deletions

        # æŒ‰æª”æ¡ˆé¡å‹çµ±è¨ˆ
        ext = File.extname(filename).sub(/^\./, '') || 'no-ext'
        @stats[current_date][:files][ext] ||= { additions: 0, deletions: 0 }
        @stats[current_date][:files][ext][:additions] += additions
        @stats[current_date][:files][ext][:deletions] += deletions
      end
    end
  end

  # æ±ºå®šæ˜¯å¦è·³éè©²æª”æ¡ˆ
  def should_skip?(filename)
    skip_patterns = [
      /node_modules/,
      /\.bundle/,
      /vendor\/bundle/,
      /\.lock$/,
      /\.DS_Store/,
      /\.log$/
    ]

    skip_patterns.any? { |pattern| filename.match?(pattern) }
  end

  # è¼¸å‡ºè¡¨æ ¼
  def print_table
    return puts "âŒ æ²’æœ‰æ‰¾åˆ° Git çµ±è¨ˆè³‡è¨Š" if @stats.empty?

    sorted_dates = @stats.keys.sort

    # è¨ˆç®—ç¸½çµ±è¨ˆ
    total_additions = @stats.values.sum { |v| v[:additions] }
    total_deletions = @stats.values.sum { |v| v[:deletions] }
    total_net = total_additions - total_deletions

    # è¡¨é ­
    puts "\n"
    puts Colors.bold("ğŸ“Š æ—¥ç¨‹å¼è¡Œæ•¸çµ±è¨ˆ")
    puts Colors.dim("=" * 80)

    # è¡¨æ ¼é ­éƒ¨
    printf "%-12s | %10s | %10s | %10s | %15s\n",
           Colors.bold("æ—¥æœŸ"),
           Colors.bold("â• æ–°å¢"),
           Colors.bold("â– åˆªé™¤"),
           Colors.bold("ğŸ”„ æ·¨è®ŠåŒ–"),
           Colors.bold("ä¸»è¦æª”æ¡ˆé¡å‹")

    puts Colors.dim("-" * 80)

    # è¡¨æ ¼å…§å®¹
    sorted_dates.each do |date|
      stats = @stats[date]
      additions = stats[:additions]
      deletions = stats[:deletions]
      net = additions - deletions

      # å–ä¸»è¦æª”æ¡ˆé¡å‹
      top_files = stats[:files]
        .sort_by { |_, v| v[:additions] + v[:deletions] }
        .reverse
        .first(2)
        .map { |ext, v| "#{ext}(#{v[:additions]})" }
        .join(", ")

      # é¡è‰²ç·¨ç¢¼
      net_color = if net > 0
                    Colors.green("+#{net}")
                  elsif net < 0
                    Colors.red("#{net}")
                  else
                    Colors.dim("Â±0")
                  end

      printf "%-12s | %10s | %10s | %10s | %15s\n",
             Colors.blue(date),
             Colors.green("+#{additions}"),
             Colors.red("-#{deletions}"),
             net_color,
             top_files[0..29]  # é™åˆ¶é•·åº¦
    end

    # è¡¨å°¾
    puts Colors.dim("-" * 80)

    # çµ±è¨ˆæ‘˜è¦
    printf "%-12s | %10s | %10s | %10s\n",
           Colors.bold("ç¸½è¨ˆ"),
           Colors.green("+#{total_additions}"),
           Colors.red("-#{total_deletions}"),
           total_net > 0 ? Colors.green("+#{total_net}") : Colors.red("#{total_net}")

    puts Colors.dim("=" * 80)

    # é¡å¤–çµ±è¨ˆè³‡è¨Š
    puts "\nğŸ“ˆ é¡å¤–çµ±è¨ˆï¼š"
    puts "  â€¢ çµ±è¨ˆå¤©æ•¸ï¼š#{sorted_dates.length} å¤©"
    puts "  â€¢ æ¯æ—¥å¹³å‡æ–°å¢ï¼š#{(total_additions / sorted_dates.length).round} è¡Œ"
    puts "  â€¢ æ·¨å¢åŠ ï¼š#{Colors.green("+#{total_net}")} è¡Œ"

    # æª”æ¡ˆé¡å‹çµ±è¨ˆ
    puts "\nğŸ“ æŒ‰æª”æ¡ˆé¡å‹çµ±è¨ˆï¼š"
    all_files = {}
    @stats.values.each do |stat|
      stat[:files].each do |ext, file_stat|
        all_files[ext] ||= { additions: 0, deletions: 0 }
        all_files[ext][:additions] += file_stat[:additions]
        all_files[ext][:deletions] += file_stat[:deletions]
      end
    end

    all_files
      .sort_by { |_, v| v[:additions] + v[:deletions] }
      .reverse
      .first(10)
      .each do |ext, stat|
        net = stat[:additions] - stat[:deletions]
        printf "  â€¢ %-10s: +%-6d -%-6d (æ·¨: %+6d)\n",
               ext,
               stat[:additions],
               stat[:deletions],
               net
      end

    puts ""
  end
end

# å‘½ä»¤è¡Œé¸é …
options = {}
OptionParser.new do |opts|
  opts.banner = "ä½¿ç”¨æ–¹å¼: bin/stats [é¸é …]"

  opts.on("-d", "--days N", Integer, "åªçµ±è¨ˆéå» N å¤©") do |n|
    options[:days] = n
  end

  opts.on("-h", "--help", "é¡¯ç¤ºå¹«åŠ©") do
    puts opts
    exit
  end
end.parse!

# åŸ·è¡Œ
stats = GitStats.new
stats.collect_daily_stats

# å¦‚æœæŒ‡å®šäº†å¤©æ•¸ï¼Œå‰‡ç¯©é¸
if options[:days]
  cutoff_date = (Date.today - options[:days]).to_s
  stats.instance_variable_get(:@stats).reject! { |date, _| date < cutoff_date }
end

stats.print_table
