<div class="flex min-h-screen bg-slate-50">
  <!-- Left Sidebar - Fixed Position (Flexy Style) -->
  <div class="w-80 bg-white fixed left-0 top-0 h-screen border-r border-gray-200 overflow-y-auto flex flex-col">
    <!-- Top Section: Logo & Navigation -->
    <div class="flex-1 overflow-y-auto">
      <!-- Logo Section -->
      <div class="p-6 border-b border-gray-200">
        <a href="/" class="flex items-center space-x-2 mb-8">
          <span class="text-2xl">ğŸ’š</span>
          <div>
            <h2 class="text-sm font-bold text-gray-900">FHIR LINE Bot</h2>
            <p class="text-xs text-gray-500">Healthcare Platform</p>
          </div>
        </a>

        <!-- Navigation Menu -->
        <nav class="space-y-1">
          <a href="/" class="flex items-center space-x-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition text-sm">
            <span class="text-lg">ğŸ </span>
            <span>é¦–é </span>
          </a>
          <a href="/setup" class="flex items-center space-x-3 px-4 py-2 text-gray-900 bg-blue-50 rounded-lg transition text-sm font-semibold border-l-4 border-blue-600">
            <span class="text-lg">âš™ï¸</span>
            <span>è¨­å®š</span>
          </a>
          <a href="/dashboard" class="flex items-center space-x-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition text-sm">
            <span class="text-lg">ğŸ“Š</span>
            <span>å„€è¡¨æ¿</span>
          </a>
          <a href="/users" class="flex items-center space-x-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition text-sm">
            <span class="text-lg">ğŸ‘¥</span>
            <span>ç”¨æˆ¶ç®¡ç†</span>
          </a>
          <a href="/settings" class="flex items-center space-x-3 px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition text-sm">
            <span class="text-lg">ğŸ”§</span>
            <span>ç³»çµ±è¨­ç½®</span>
          </a>
        </nav>
      </div>

    </div>

    <!-- Bottom Section: User Profile -->
    <div class="border-t border-gray-200 p-6 mt-auto">
      <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition">
        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
          A
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-xs font-semibold text-gray-900">Administrator</p>
          <p class="text-xs text-gray-500 truncate">admin@example.com</p>
        </div>
        <span class="text-lg">â‹®</span>
      </div>
    </div>
  </div>

  <!-- Right Content - Main Area (ml-80 for fixed sidebar width) -->
  <div class="flex-1 ml-80 overflow-y-auto">
    <div class="max-w-5xl mx-auto px-6 py-8">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-1">FHIR LINE Bot Setup</h1>
        <p class="text-gray-600">è¨­å®šæ‚¨çš„ LINE OAuth æ†‘è­‰</p>
      </div>

      <!-- Content Grid: Steps on left, Form on right -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Steps Guide -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm p-6 sticky top-6">
            <h3 class="font-bold text-gray-900 mb-4 flex items-center space-x-2">
              <span class="text-lg">ğŸ“‹</span>
              <span>è¨­å®šæ­¥é©Ÿ</span>
            </h3>

            <div class="space-y-4">
              <!-- Step 1 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">1</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">ç²å– LINE æ†‘è­‰</p>
                  <p class="text-xs text-gray-500 mt-0.5">å‰å¾€ LINE Developers Console</p>
                </div>
              </div>

              <!-- Step 2 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">2</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">å»ºç«‹ Login é »é“</p>
                  <p class="text-xs text-gray-500 mt-0.5">å»ºç«‹æ–°çš„æœå‹™é »é“</p>
                </div>
              </div>

              <!-- Step 3 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">3</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">è¤‡è£½æ†‘è­‰</p>
                  <p class="text-xs text-gray-500 mt-0.5">Channel ID å’Œ Secret</p>
                </div>
              </div>

              <!-- Step 4 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">4</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">é©—è­‰ä¸¦å„²å­˜</p>
                  <p class="text-xs text-gray-500 mt-0.5">å®Œæˆè¨­å®š</p>
                </div>
              </div>
            </div>

            <!-- Help Link -->
            <div class="border-t border-gray-200 pt-4 mt-6">
              <a href="https://developers.line.biz/" target="_blank" class="text-sm text-blue-600 hover:text-blue-700 font-semibold inline-flex items-center space-x-1">
                <span>ğŸ“– è¨­å®šæŒ‡å—</span>
                <span>â†’</span>
              </a>
            </div>

            <!-- Status Section -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h4 class="font-semibold text-gray-900 mb-3 text-sm">ç‹€æ…‹</h4>
              <% if @configured %>
                <div class="flex items-start space-x-2">
                  <span class="text-lg flex-shrink-0">âœ“</span>
                  <div class="min-w-0">
                    <p class="font-medium text-green-900 text-sm">å·²è¨­å®š</p>
                    <p class="text-xs text-green-700">é©—è­‰æ™‚é–“ï¼š<%= @setting.last_validated_at.strftime("%m/%d %H:%M") %></p>
                  </div>
                </div>
              <% else %>
                <div class="flex items-start space-x-2">
                  <span class="text-lg flex-shrink-0">â³</span>
                  <div class="min-w-0">
                    <p class="font-medium text-amber-900 text-sm">å¾…è¨­å®š</p>
                    <p class="text-xs text-amber-700">è«‹å®Œæˆé…ç½®</p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Right: Form -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-sm">
            <!-- Form Header -->
            <div class="border-b border-gray-200 px-6 py-6 bg-gradient-to-r from-blue-50 to-indigo-50">
              <h2 class="text-2xl font-bold text-gray-900">è¼¸å…¥æ‚¨çš„ LINE æ†‘è­‰</h2>
              <p class="text-sm text-gray-600 mt-1">åœ¨ä¸‹æ–¹è¼¸å…¥æ‚¨çš„ Channel ID å’Œ Channel Secret</p>
            </div>

        <!-- Form Body -->
        <div class="px-6 py-6">
          <form id="setup-form" action="<%= update_setup_path %>" method="post">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

            <!-- Channel ID Field -->
            <div class="mb-6">
              <label for="channel_id" class="block text-sm font-semibold text-gray-900 mb-1.5">
                Channel ID <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="channel_id"
                name="line_channel_id"
                value="<%= @setting.line_channel_id %>"
                placeholder="1234567890"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                required
              />
              <p class="text-xs text-gray-500 mt-1">
                åœ¨ LINE Developers Console çš„ Channel è¨­å®šä¸­å¯æ‰¾åˆ°
              </p>
            </div>

            <!-- Channel Secret Field -->
            <div class="mb-6">
              <label for="channel_secret" class="block text-sm font-semibold text-gray-900 mb-1.5">
                Channel Secret <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="channel_secret"
                  name="line_channel_secret"
                  value="<%= @setting.line_channel_secret %>"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  required
                />
                <button
                  type="button"
                  id="toggle-secret"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 text-sm"
                  onclick="toggleSecretVisibility()"
                >
                  ğŸ‘ï¸
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                æ•æ„Ÿè³‡æ–™ - ç‚ºå®‰å…¨èµ·è¦‹ä»¥é»é¡¯ç¤º
              </p>
            </div>

            <!-- Error Message -->
            <% if @setting.validation_error.present? %>
              <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start space-x-2">
                <span class="text-base flex-shrink-0 pt-0.5">âœ—</span>
                <div class="flex-1">
                  <p class="text-xs font-semibold text-red-900">é©—è­‰éŒ¯èª¤</p>
                  <p class="text-xs text-red-700"><%= @setting.validation_error %></p>
                </div>
              </div>
            <% end %>

            <!-- Validation Status -->
            <div id="validation-status" class="mb-4 hidden">
              <!-- å°‡æœƒå‹•æ…‹æ’å…¥è­¦å‘Šè¨Šæ¯ -->
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-2">
              <button
                type="button"
                id="validate-btn"
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm"
              >
                âœ“ é©—è­‰æ†‘è­‰
              </button>
              <button
                type="submit"
                id="save-btn"
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm"
                disabled
              >
                ğŸ’¾ å„²å­˜ä¸¦ç¹¼çºŒ
              </button>
            </div>

            <% if @configured %>
              <button
                type="button"
                id="test-btn"
                class="w-full mt-2 px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition text-sm"
              >
                ğŸ§ª æ¸¬è©¦é€£ç·š
              </button>

              <button
                type="button"
                id="clear-btn"
                class="w-full mt-2 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition text-sm"
              >
                ğŸ”„ é‡æ–°è¨­å®šæ†‘è­‰
              </button>
            <% end %>
          </form>

          <!-- Security Info -->
          <div class="border-t border-gray-200 px-6 py-4 bg-gray-50">
            <div class="flex items-start space-x-2">
              <span class="text-lg flex-shrink-0">ğŸ”’</span>
              <div>
                <p class="text-xs font-semibold text-gray-900">å®‰å…¨æ€§</p>
                <p class="text-xs text-gray-600 mt-0.5">æ‚¨çš„ Channel Secret æœƒè¢«åŠ å¯†ä¸¦å®‰å…¨åœ°å„²å­˜ã€‚å„²å­˜å¾Œæ°¸é ä¸æœƒä»¥ç´”æ–‡å­—é¡¯ç¤ºã€‚</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for form handling -->
<script>
  // Toggle secret visibility
  function toggleSecretVisibility() {
    const secretInput = document.getElementById('channel_secret');
    const isPassword = secretInput.type === 'password';
    secretInput.type = isPassword ? 'text' : 'password';
  }

  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('setup-form');
    const validateBtn = document.getElementById('validate-btn');
    const saveBtn = document.getElementById('save-btn');
    const testBtn = document.getElementById('test-btn');
    const clearBtn = document.getElementById('clear-btn');
    const statusDiv = document.getElementById('validation-status');

    let validationPassed = false;

    // å‰µå»ºå‹•æ…‹è­¦å‘Šè¨Šæ¯çš„è¼”åŠ©å‡½æ•¸
    function showStatus(message, type = 'info') {
      statusDiv.classList.remove('hidden');

      let bgClass = 'bg-blue-50';
      let borderClass = 'border-blue-200';
      let textClass = 'text-blue-900';
      let icon = 'â„¹ï¸';

      switch(type) {
        case 'success':
          bgClass = 'bg-green-50';
          borderClass = 'border-green-200';
          textClass = 'text-green-900';
          icon = 'âœ“';
          break;
        case 'error':
          bgClass = 'bg-red-50';
          borderClass = 'border-red-200';
          textClass = 'text-red-900';
          icon = 'âœ—';
          break;
        case 'loading':
          bgClass = 'bg-blue-50';
          borderClass = 'border-blue-200';
          textClass = 'text-blue-900';
          icon = 'â³';
          break;
      }

      statusDiv.innerHTML = `
        <div class="${bgClass} border ${borderClass} rounded-lg p-3 flex items-start space-x-2">
          <span class="text-base flex-shrink-0">${icon}</span>
          <div class="flex-1">
            <p class="text-xs ${textClass} font-medium">${message}</p>
          </div>
        </div>
      `;
    }

    // é©—è­‰æ†‘è­‰
    validateBtn?.addEventListener('click', async function() {
      const channelId = document.getElementById('channel_id').value;
      const channelSecret = document.getElementById('channel_secret').value;

      if (!channelId || !channelSecret) {
        showStatus('è«‹å¡«å¯« Channel ID å’Œ Channel Secret', 'error');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      showStatus('æ­£åœ¨é©—è­‰æ†‘è­‰...', 'loading');
      validateBtn.disabled = true;

      try {
        const response = await fetch('<%= validate_line_credentials_path %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({
            line_channel_id: channelId,
            line_channel_secret: channelSecret
          })
        });

        const data = await response.json();

        if (data.success) {
          showStatus('æ†‘è­‰é©—è­‰æˆåŠŸï¼', 'success');
          saveBtn.disabled = false;
          validationPassed = true;
        } else {
          showStatus(data.message || 'é©—è­‰å¤±æ•—', 'error');
          saveBtn.disabled = true;
          validationPassed = false;
        }
      } catch (error) {
        showStatus('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message, 'error');
        saveBtn.disabled = true;
        validationPassed = false;
      } finally {
        validateBtn.disabled = false;
      }
    });

    // å„²å­˜è¡¨å–®
    form?.addEventListener('submit', function(e) {
      if (!validationPassed) {
        e.preventDefault();
        showStatus('è«‹å…ˆé©—è­‰æ†‘è­‰', 'error');
        return;
      }
    });

    // æ¸¬è©¦ç¾æœ‰è¨­å®šçš„é€£ç·š
    testBtn?.addEventListener('click', async function() {
      testBtn.disabled = true;
      const originalText = testBtn.textContent;
      testBtn.textContent = 'ğŸ§ª æ¸¬è©¦ä¸­...';

      try {
        const response = await fetch('<%= test_setup_path %>', {
          method: 'POST',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          }
        });

        const data = await response.json();

        // å‰µå»ºæ¨¡æ…‹æ¡†é¡¯ç¤ºçµæœ
        const modalHtml = `
          <div id="test-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4">
              <div class="border-b border-gray-200 px-6 py-4">
                <h3 class="text-lg font-bold text-gray-900">${data.success ? 'âœ“ é€£ç·šæˆåŠŸ' : 'âœ— é€£ç·šå¤±æ•—'}</h3>
              </div>
              <div class="px-6 py-4">
                <p class="text-sm text-gray-700 mb-2">${data.success ? 'é€£ç·šæ¸¬è©¦æˆåŠŸï¼' : 'é€£ç·šæ¸¬è©¦å¤±æ•—'}</p>
                <p class="text-xs text-gray-500">${data.success ? 'æœ€å¾Œé©—è­‰ï¼š' + data.last_validated : data.message}</p>
              </div>
              <div class="border-t border-gray-200 px-6 py-3 flex justify-end">
                <button onclick="document.getElementById('test-modal').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">ç¢ºå®š</button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (error) {
        showStatus('éŒ¯èª¤ï¼š' + error.message, 'error');
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = originalText;
      }
    });

    // æ¸…é™¤è¨­å®š
    clearBtn?.addEventListener('click', function() {
      // å‰µå»ºç¢ºèªæ¨¡æ…‹æ¡†
      const confirmHtml = `
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4">
              <h3 class="text-lg font-bold text-gray-900">ç¢ºèªé‡æ–°è¨­å®š</h3>
            </div>
            <div class="px-6 py-4">
              <p class="text-sm text-gray-700">æ‚¨ç¢ºå®šè¦æ¸…é™¤è¨­å®šå—ï¼Ÿæ‚¨å°‡éœ€è¦é‡æ–°è¨­å®šã€‚</p>
            </div>
            <div class="border-t border-gray-200 px-6 py-3 flex justify-end gap-2">
              <button onclick="document.getElementById('confirm-modal').remove()" class="px-4 py-2 bg-gray-300 text-gray-900 rounded-lg font-medium hover:bg-gray-400">å–æ¶ˆ</button>
              <button id="confirm-clear" class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">ç¢ºèªæ¸…é™¤</button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', confirmHtml);

      document.getElementById('confirm-clear').addEventListener('click', function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '<%= clear_setup_path %>';
        form.innerHTML = '<input type="hidden" name="_method" value="DELETE" /><input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>" />';
        document.body.appendChild(form);
        form.submit();
      });
    });
  });
</script>
