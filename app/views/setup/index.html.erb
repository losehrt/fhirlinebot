<div class="max-w-5xl mx-auto px-6 py-8">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-1">FHIR LINE Bot Setup</h1>
        <p class="text-gray-600">設定您的 LINE OAuth 憑證</p>
      </div>

      <!-- Content Grid: Steps on left, Form on right -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Steps Guide -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm p-6 sticky top-6">
            <h3 class="font-bold text-gray-900 mb-4">設定步驟</h3>

            <div class="space-y-4">
              <!-- Step 1 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">1</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">獲取 LINE 憑證</p>
                  <p class="text-xs text-gray-500 mt-0.5">前往 LINE Developers Console</p>
                </div>
              </div>

              <!-- Step 2 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">2</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">建立 Login 頻道</p>
                  <p class="text-xs text-gray-500 mt-0.5">建立新的服務頻道</p>
                </div>
              </div>

              <!-- Step 3 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">3</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">複製憑證</p>
                  <p class="text-xs text-gray-500 mt-0.5">Channel ID 和 Secret</p>
                </div>
              </div>

              <!-- Step 4 -->
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">4</div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900">驗證並儲存</p>
                  <p class="text-xs text-gray-500 mt-0.5">完成設定</p>
                </div>
              </div>
            </div>

            <!-- Help Link -->
            <div class="border-t border-gray-200 pt-4 mt-6">
              <a href="https://developers.line.biz/" target="_blank" class="text-sm text-blue-600 hover:text-blue-700 font-semibold inline-flex items-center space-x-1">
                <span>設定指南</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"/>
                  <polyline points="12 5 19 12 12 19"/>
                </svg>
              </a>
            </div>

            <!-- Status Section -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h4 class="font-semibold text-gray-900 mb-3 text-sm">狀態</h4>
              <% if @configured %>
                <div class="flex items-start space-x-2">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600 flex-shrink-0 mt-0.5">
                    <path d="M20 6L9 17l-5-5"/>
                  </svg>
                  <div class="min-w-0">
                    <p class="font-medium text-green-900 text-sm">已設定</p>
                    <p class="text-xs text-green-700">驗證時間：<%= @setting.last_validated_at.strftime("%m/%d %H:%M") %></p>
                  </div>
                </div>
              <% else %>
                <div class="flex items-start space-x-2">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-amber-600 flex-shrink-0 mt-0.5 animate-pulse">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  <div class="min-w-0">
                    <p class="font-medium text-amber-900 text-sm">待設定</p>
                    <p class="text-xs text-amber-700">請完成配置</p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Right: Form -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-sm">
            <!-- Form Header -->
            <div class="border-b border-gray-200 px-6 py-6 bg-gradient-to-r from-blue-50 to-indigo-50">
              <h2 class="text-2xl font-bold text-gray-900">輸入您的 LINE 憑證</h2>
              <p class="text-sm text-gray-600 mt-1">在下方輸入您的 Channel ID 和 Channel Secret</p>
            </div>

        <!-- Form Body -->
        <div class="px-6 py-6"
             data-controller="setup"
             data-setup-validate-path-value="<%= validate_line_credentials_path %>"
             data-setup-test-path-value="<%= test_setup_path %>"
             data-setup-clear-path-value="<%= clear_setup_path %>"
             data-setup-validated-value="false">

          <form data-setup-target="form"
                action="<%= update_setup_path %>"
                method="post"
                data-action="submit->setup#submit">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

            <!-- Channel ID Field -->
            <div class="mb-6">
              <label for="channel_id" class="block text-sm font-semibold text-gray-900 mb-1.5">
                Channel ID <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="channel_id"
                name="line_channel_id"
                value="<%= @setting.line_channel_id %>"
                placeholder="1234567890"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                data-setup-target="channelId"
                required
              />
              <p class="text-xs text-gray-500 mt-1">
                在 LINE Developers Console 的 Channel 設定中可找到
              </p>
            </div>

            <!-- Channel Secret Field -->
            <div class="mb-6">
              <label for="channel_secret" class="block text-sm font-semibold text-gray-900 mb-1.5">
                Channel Secret <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="channel_secret"
                  name="line_channel_secret"
                  value="<%= @setting.line_channel_secret %>"
                  placeholder="••••••••••••••••"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  data-setup-target="channelSecret"
                  required
                />
                <button
                  type="button"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  data-action="click->setup#toggleSecret"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                敏感資料 - 為安全起見以點顯示
              </p>
            </div>

            <!-- Validation Status -->
            <div data-setup-target="validationStatus" class="mb-4 <%= @setting.validation_error.present? ? '' : 'hidden' %>">
              <% if @setting.validation_error.present? %>
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 flex items-start space-x-2">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-600 flex-shrink-0 mt-0.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                  </svg>
                  <div class="flex-1">
                    <p class="text-xs text-red-900 font-medium"><%= @setting.validation_error %></p>
                  </div>
                </div>
              <% end %>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-2">
              <button
                type="button"
                data-setup-target="validateBtn"
                data-action="click->setup#validate"
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm"
              >
                驗證憑證
              </button>
              <button
                type="submit"
                data-setup-target="saveBtn"
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed text-sm"
                disabled
              >
                儲存並繼續
              </button>
            </div>

            <% if @configured %>
              <button
                type="button"
                data-setup-target="testBtn"
                data-action="click->setup#test"
                class="w-full mt-2 px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition text-sm"
              >
                測試連線
              </button>

              <button
                type="button"
                data-setup-target="clearBtn"
                data-action="click->setup#clear"
                class="w-full mt-2 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition text-sm"
              >
                重新設定憑證
              </button>
            <% end %>
          </form>

          <!-- Security Info -->
          <div class="border-t border-gray-200 px-6 py-4 bg-gray-50">
            <div class="flex items-start space-x-2">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600 flex-shrink-0 mt-0.5">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
              <div>
                <p class="text-xs font-semibold text-gray-900">安全性</p>
                <p class="text-xs text-gray-600 mt-0.5">您的 Channel Secret 會被加密並安全地儲存。儲存後永遠不會以純文字顯示。</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
