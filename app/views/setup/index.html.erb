<div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
  <!-- Header with Breadcrumb -->
  <div class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-4xl mx-auto px-4 py-4">
      <!-- Breadcrumb -->
      <nav class="rb-breadcrumb mb-4">
        <a href="/" class="rb-breadcrumb-item">é¦–é </a>
        <span class="rb-breadcrumb-separator">/</span>
        <span class="rb-breadcrumb-item text-gray-900">è¨­å®š</span>
      </nav>

      <!-- Header Content -->
      <div class="flex items-center space-x-3">
        <div class="text-4xl">âš™ï¸</div>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">FHIR LINE Bot Setup</h1>
          <p class="text-gray-600 mt-1">è¨­å®šæ‚¨çš„ LINE OAuth æ†‘è­‰</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Status Card using Rails Block -->
    <div class="rb-card mb-8">
      <div class="rb-card-body">
        <div class="flex items-center space-x-4">
          <div class="flex-shrink-0">
            <% if @configured %>
              <span class="rb-badge rb-badge-success" style="width: 48px; height: 48px; font-size: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                âœ“
              </span>
            <% else %>
              <span class="rb-badge rb-badge-warning" style="width: 48px; height: 48px; font-size: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                !
              </span>
            <% end %>
          </div>
          <div class="flex-1">
            <h2 class="text-lg font-bold text-gray-900">
              <% if @configured %>
                âœ“ LINE æ†‘è­‰å·²è¨­å®š
              <% else %>
                âš  LINE æ†‘è­‰å°šæœªè¨­å®š
              <% end %>
            </h2>
            <p class="text-gray-600 text-sm">
              <% if @configured %>
                æ‚¨çš„ LINE æ†‘è­‰å·²è¨­å®šä¸¦é©—è­‰ã€‚æœ€å¾Œé©—è­‰æ™‚é–“ï¼š<%= @setting.last_validated_at.strftime("%Y-%m-%d %H:%M") %>
              <% else %>
                è«‹è¨­å®šæ‚¨çš„ LINE OAuth æ†‘è­‰ä»¥ä½¿ç”¨æ­¤æ‡‰ç”¨ç¨‹å¼ã€‚
              <% end %>
            </p>
          </div>
          <% if @configured %>
            <button type="button" id="test-btn" class="rb-btn rb-btn-primary">
              æ¸¬è©¦é€£ç·š
            </button>
          <% end %>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Left Column: Instructions -->
      <div class="md:col-span-1">
        <div class="rb-card sticky top-4">
          <div class="rb-card-header">
            <h3 class="text-lg font-bold text-gray-900">ğŸ“‹ è¨­å®šæ­¥é©Ÿ</h3>
          </div>
          <div class="rb-card-body">
            <ol class="space-y-3">
              <li class="flex items-start space-x-3">
                <span class="rb-badge rb-badge-success" style="min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">1</span>
                <span class="text-sm text-gray-700">
                  <a href="https://developers.line.biz/" target="_blank" class="text-blue-600 hover:underline">
                    å‰å¾€ LINE Developers Console
                  </a>
                </span>
              </li>
              <li class="flex items-start space-x-3">
                <span class="rb-badge rb-badge-success" style="min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">2</span>
                <span class="text-sm text-gray-700">å»ºç«‹æ–°çš„ "Login" æœå‹™é »é“</span>
              </li>
              <li class="flex items-start space-x-3">
                <span class="rb-badge rb-badge-success" style="min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">3</span>
                <span class="text-sm text-gray-700">è¤‡è£½ Channel ID å’Œ Channel Secret</span>
              </li>
              <li class="flex items-start space-x-3">
                <span class="rb-badge rb-badge-success" style="min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">4</span>
                <span class="text-sm text-gray-700">è²¼åˆ°å³å´çš„è¡¨å–®ä¸­</span>
              </li>
              <li class="flex items-start space-x-3">
                <span class="rb-badge rb-badge-success" style="min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">5</span>
                <span class="text-sm text-gray-700">é»æ“Šã€Œé©—è­‰ä¸¦å„²å­˜ã€å®Œæˆè¨­å®š</span>
              </li>
            </ol>

            <div class="rb-alert rb-alert-info mt-6">
              <p class="text-sm">
                <strong>éœ€è¦å¹«åŠ©ï¼Ÿ</strong> æŸ¥çœ‹æˆ‘å€‘çš„
                <a href="/SETUP.md" class="text-blue-600 hover:underline">è¨­å®šæŒ‡å—</a>
                ä»¥ç²å¾—è©³ç´°èªªæ˜ã€‚
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Configuration Form -->
      <div class="md:col-span-2">
        <div class="rb-card">
          <div class="rb-card-header">
            <h3 class="text-xl font-bold text-gray-900">è¼¸å…¥æ‚¨çš„ LINE æ†‘è­‰</h3>
          </div>
          <div class="rb-card-body">
            <form id="setup-form" action="<%= update_setup_path %>" method="post">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

              <!-- Channel ID Field -->
              <div class="rb-form-group">
                <label for="channel_id" class="rb-label">
                  Channel ID <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="channel_id"
                  name="line_channel_id"
                  value="<%= @setting.line_channel_id %>"
                  placeholder="æ‚¨çš„ LINE Channel ID (æ•¸å­—)"
                  class="rb-input"
                  required
                />
                <p class="text-xs text-gray-500 mt-1">
                  åœ¨ LINE Developers Console çš„ Channel è¨­å®šä¸­å¯æ‰¾åˆ°
                </p>
              </div>

              <!-- Channel Secret Field -->
              <div class="rb-form-group">
                <label for="channel_secret" class="rb-label">
                  Channel Secret <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  id="channel_secret"
                  name="line_channel_secret"
                  value="<%= @setting.line_channel_secret %>"
                  placeholder="æ‚¨çš„ LINE Channel Secret"
                  class="rb-input"
                  required
                />
                <p class="text-xs text-gray-500 mt-1">
                  æ•æ„Ÿè³‡æ–™ - ç‚ºå®‰å…¨èµ·è¦‹ä»¥é»é¡¯ç¤º
                </p>
              </div>

              <!-- Error Message -->
              <% if @setting.validation_error.present? %>
                <div class="rb-alert rb-alert-error" data-controller="alert">
                  <div class="flex justify-between items-center">
                    <p class="text-sm">
                      <strong>é©—è­‰éŒ¯èª¤ï¼š</strong> <%= @setting.validation_error %>
                    </p>
                    <button data-action="click->alert#dismiss" class="text-red-600 hover:text-red-800">âœ•</button>
                  </div>
                </div>
              <% end %>

              <!-- Validation Status -->
              <div id="validation-status" class="hidden">
                <!-- å°‡æœƒå‹•æ…‹æ’å…¥è­¦å‘Šè¨Šæ¯ -->
              </div>

              <!-- Action Buttons -->
              <div class="flex space-x-4 pt-4">
                <button
                  type="button"
                  id="validate-btn"
                  class="rb-btn rb-btn-primary flex-1"
                >
                  âœ“ é©—è­‰æ†‘è­‰
                </button>
                <button
                  type="submit"
                  id="save-btn"
                  class="rb-btn rb-btn-success flex-1"
                  disabled
                >
                  ğŸ’¾ å„²å­˜ä¸¦ç¹¼çºŒ
                </button>
              </div>

              <% if @configured %>
                <button
                  type="button"
                  id="clear-btn"
                  class="rb-btn rb-btn-danger w-full mt-4"
                >
                  ğŸ”„ é‡æ–°è¨­å®šæ†‘è­‰
                </button>
              <% end %>
            </form>
          </div>
        </div>

        <!-- Security Info Box -->
        <div class="rb-alert rb-alert-success mt-6">
          <p class="text-sm">
            <strong>ğŸ”’ å®‰å…¨æ€§ï¼š</strong> æ‚¨çš„ Channel Secret æœƒè¢«åŠ å¯†ä¸¦å®‰å…¨åœ°å„²å­˜ã€‚å„²å­˜å¾Œæ°¸é ä¸æœƒä»¥ç´”æ–‡å­—é¡¯ç¤ºã€‚
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript for form handling -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('setup-form');
      const validateBtn = document.getElementById('validate-btn');
      const saveBtn = document.getElementById('save-btn');
      const testBtn = document.getElementById('test-btn');
      const clearBtn = document.getElementById('clear-btn');
      const statusDiv = document.getElementById('validation-status');

      let validationPassed = false;

      // å‰µå»ºå‹•æ…‹è­¦å‘Šè¨Šæ¯çš„è¼”åŠ©å‡½æ•¸
      function showStatus(message, type = 'info') {
        statusDiv.classList.remove('hidden');

        let alertClass = 'rb-alert-info';
        let iconColor = 'blue';
        let icon = 'â„¹';

        switch(type) {
          case 'success':
            alertClass = 'rb-alert-success';
            iconColor = 'green';
            icon = 'âœ“';
            break;
          case 'error':
            alertClass = 'rb-alert-error';
            iconColor = 'red';
            icon = 'âœ—';
            break;
          case 'loading':
            alertClass = 'rb-alert-info';
            iconColor = 'blue';
            icon = '<div class="rb-spinner text-blue-600" style="width: 16px; height: 16px;"></div>';
            break;
        }

        statusDiv.innerHTML = `
          <div class="rb-alert ${alertClass}" data-controller="alert">
            <div class="flex items-center space-x-2">
              ${type === 'loading' ? icon : `<span>${icon}</span>`}
              <span>${message}</span>
            </div>
          </div>
        `;
      }

      // é©—è­‰æ†‘è­‰
      validateBtn?.addEventListener('click', async function() {
        const channelId = document.getElementById('channel_id').value;
        const channelSecret = document.getElementById('channel_secret').value;

        if (!channelId || !channelSecret) {
          showStatus('è«‹å¡«å¯« Channel ID å’Œ Channel Secret', 'error');
          return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        showStatus('æ­£åœ¨é©—è­‰æ†‘è­‰...', 'loading');
        validateBtn.disabled = true;
        validateBtn.classList.add('disabled:bg-gray-400');

        try {
          const response = await fetch('<%= validate_line_credentials_path %>', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
              line_channel_id: channelId,
              line_channel_secret: channelSecret
            })
          });

          const data = await response.json();

          if (data.success) {
            showStatus('æ†‘è­‰é©—è­‰æˆåŠŸï¼', 'success');
            saveBtn.disabled = false;
            saveBtn.classList.remove('disabled:bg-gray-400');
            validationPassed = true;
          } else {
            showStatus(data.message || 'é©—è­‰å¤±æ•—', 'error');
            saveBtn.disabled = true;
            saveBtn.classList.add('disabled:bg-gray-400');
            validationPassed = false;
          }
        } catch (error) {
          showStatus('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message, 'error');
          saveBtn.disabled = true;
          saveBtn.classList.add('disabled:bg-gray-400');
          validationPassed = false;
        } finally {
          validateBtn.disabled = false;
          validateBtn.classList.remove('disabled:bg-gray-400');
        }
      });

      // å„²å­˜è¡¨å–®
      form?.addEventListener('submit', function(e) {
        if (!validationPassed) {
          e.preventDefault();
          showStatus('è«‹å…ˆé©—è­‰æ†‘è­‰', 'error');
          return;
        }
      });

      // æ¸¬è©¦ç¾æœ‰è¨­å®šçš„é€£ç·š
      testBtn?.addEventListener('click', async function() {
        testBtn.disabled = true;
        testBtn.classList.add('disabled:bg-gray-400');
        const originalText = testBtn.textContent;
        testBtn.innerHTML = '<span class="rb-spinner" style="width: 16px; height: 16px; display: inline-block; margin-right: 8px;"></span>æ¸¬è©¦ä¸­...';

        try {
          const response = await fetch('<%= test_setup_path %>', {
            method: 'POST',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            }
          });

          const data = await response.json();

          // å‰µå»ºæ¨¡æ…‹æ¡†é¡¯ç¤ºçµæœ
          const modalHtml = `
            <div data-controller="modal">
              <div class="rb-modal-backdrop" data-modal-target="backdrop"></div>
              <div class="rb-modal" data-modal-target="modal">
                <div class="rb-modal-content">
                  <div class="rb-modal-header">
                    <h3 class="text-lg font-semibold">${data.success ? 'âœ“ é€£ç·šæˆåŠŸ' : 'âœ— é€£ç·šå¤±æ•—'}</h3>
                  </div>
                  <div class="rb-modal-body">
                    <p>${data.success ? 'é€£ç·šæ¸¬è©¦æˆåŠŸï¼' : 'é€£ç·šæ¸¬è©¦å¤±æ•—'}</p>
                    <p class="text-sm text-gray-600 mt-2">${data.success ? 'æœ€å¾Œé©—è­‰ï¼š' + data.last_validated : data.message}</p>
                  </div>
                  <div class="rb-modal-footer">
                    <button class="rb-btn rb-btn-primary" onclick="this.closest('[data-controller=modal]').remove()">ç¢ºå®š</button>
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.insertAdjacentHTML('beforeend', modalHtml);
        } catch (error) {
          showStatus('éŒ¯èª¤ï¼š' + error.message, 'error');
        } finally {
          testBtn.disabled = false;
          testBtn.classList.remove('disabled:bg-gray-400');
          testBtn.textContent = originalText;
        }
      });

      // æ¸…é™¤è¨­å®š
      clearBtn?.addEventListener('click', function() {
        // ä½¿ç”¨ Rails Block çš„æ¨¡æ…‹æ¡†ç¢ºèª
        const confirmHtml = `
          <div data-controller="modal" id="confirm-modal">
            <div class="rb-modal-backdrop" data-modal-target="backdrop"></div>
            <div class="rb-modal" data-modal-target="modal">
              <div class="rb-modal-content">
                <div class="rb-modal-header">
                  <h3 class="text-lg font-semibold">ç¢ºèªé‡æ–°è¨­å®š</h3>
                </div>
                <div class="rb-modal-body">
                  <p>æ‚¨ç¢ºå®šè¦æ¸…é™¤è¨­å®šå—ï¼Ÿæ‚¨å°‡éœ€è¦é‡æ–°è¨­å®šã€‚</p>
                </div>
                <div class="rb-modal-footer">
                  <button class="rb-btn rb-btn-secondary" onclick="document.getElementById('confirm-modal').remove()">å–æ¶ˆ</button>
                  <button class="rb-btn rb-btn-danger" id="confirm-clear">ç¢ºèªæ¸…é™¤</button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', confirmHtml);

        document.getElementById('confirm-clear').addEventListener('click', function() {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '<%= clear_setup_path %>';
          form.innerHTML = '<input type="hidden" name="_method" value="DELETE" /><input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>" />';
          document.body.appendChild(form);
          form.submit();
        });
      });
    });
  </script>
</div>